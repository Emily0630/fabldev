factor(., 1:(P+1), 1:(P+1)) %>%
table() %>%
.[-(P+1)] %>%
as.numeric()
n_12_xi <- sum(n_p_xi)
log_ratio <- sum(n_p_xi * log(m_p) + (N_p - n_p_xi) * log(u_p)) +
sum((alpha - a) * m + (beta - b) * u) +
sapply(list(a, b), function(y){
split(y, field_marker) %>%
sapply(., function(x){
sum(lgamma(x)) - lgamma(sum(x))
})%>%
sum(.)
}) %>%
sum(.) -
sapply(list(alpha, beta), function(y){
split(y, field_marker) %>%
sapply(., function(x){
sum(lgamma(x)) - lgamma(sum(x))
})%>%
sum(.)
}) %>%
sum(.) +
(alpha_pi - a_pi + n_12_xi) * log(pi) +
(beta_pi - b_pi + n2 - n_12_xi)  * log(1 - pi) +
lbeta(a_pi, b_pi) -
lbeta(alpha_pi, beta_pi) -
n_12_xi * log(n1) - sum(log(phis)[xi] / out$C)
ratio <- exp(log_ratio)
n_12_xi
n_p_xi
pattern_probs <- lapply(1:n2, function(j){
c(out$pattern_weights * hash$pattern_counts_by_record[[j]],
exp(digamma(out$b_pi))) / out$C[j]
})
pattern_probs[[1]]
n_p_xi * log(m_p)
(N_p - n_p_xi)
N_p
(N_p - n_p_xi) * log(u_p)
sum(n_p_xi * log(m_p) + (N_p - n_p_xi) * log(u_p))
(alpha - a)
log_ratio <- sum(n_p_xi * log(m_p) + (N_p - n_p_xi) * log(u_p)) +
sum((alpha - a) * log(m) + (beta - b) * log(u)) +
sapply(list(a, b), function(y){
split(y, field_marker) %>%
sapply(., function(x){
sum(lgamma(x)) - lgamma(sum(x))
})%>%
sum(.)
}) %>%
sum(.) -
sapply(list(alpha, beta), function(y){
split(y, field_marker) %>%
sapply(., function(x){
sum(lgamma(x)) - lgamma(sum(x))
})%>%
sum(.)
}) %>%
sum(.) +
(alpha_pi - a_pi + n_12_xi) * log(pi) +
(beta_pi - b_pi + n2 - n_12_xi)  * log(1 - pi) +
lbeta(a_pi, b_pi) -
lbeta(alpha_pi, beta_pi) -
n_12_xi * log(n1) - sum(log(phis)[xi] / out$C)
ratio <- exp(log_ratio)
multivar_beta <- function(vec){
sum(lgamma(x)) - lgamma(sum(x))
}
multivar_beta(a_split)
multivar_beta <- function(x){
sum(lgamma(x)) - lgamma(sum(x))
}
multivar_beta(a_split)
log_ratio <- sum(n_p_xi * log(m_p) + (N_p - n_p_xi) * log(u_p)) +
sum((alpha - a) * log(m) + (beta - b) * log(u)) +
sapply(list(a, b), function(y){
split(y, field_marker) %>%
sapply(., function(x){
sum(lgamma(x)) - lgamma(sum(x))
})%>%
sum(.)
}) %>%
sum(.) -
sapply(a_split, multivar_beta)
sapply(a_split, multivar_beta)
sum(sapply(a_split, multivar_beta) +
sapply(b_split, multivar_beta) -
sapply(alpha, multivar_beta) -
sapply(beta, multivar_beta))
a_pi
n_12_xi
(alpha_pi - a_pi + n_12_xi) * log(pi)
log_ratio <- sum(n_p_xi * log(m_p) + (N_p - n_p_xi) * log(u_p)) +
sum((alpha - a) * log(m) + (beta - b) * log(u)) +
sum(sapply(a_split, multivar_beta) +
sapply(b_split, multivar_beta) -
sapply(alpha, multivar_beta) -
sapply(beta, multivar_beta)) +
(alpha_pi - a_pi + n_12_xi) * log(pi) +
(beta_pi - b_pi + n2 - n_12_xi)  * log(1 - pi) +
lbeta(a_pi, b_pi) -
lbeta(alpha_pi, beta_pi) -
n_12_xi * log(n1) - sum(log(phis)[xi] / out$C) #x_j = 0 is coded as P+1
ratio <- exp(log_ratio)
sum(n_p_xi * log(m_p) + (N_p - n_p_xi) * log(u_p))
sum((alpha - a) * log(m) + (beta - b) * log(u))
sum(sapply(a_split, multivar_beta) +
sapply(b_split, multivar_beta) -
sapply(alpha, multivar_beta) -
sapply(beta, multivar_beta))
sapply(a_split, multivar_beta) +
sapply(b_split, multivar_beta) -
sapply(alpha, multivar_beta) -
sapply(beta, multivar_beta)
sapply(beta, multivar_beta)
sapply(alpha, multivar_beta)
devtools::load_all(".")
roxygen2::roxygenize()
cd
library(fabldev)
library(ggplot2)
n1 <- 50
n2 <- 50
overlap <- n2/2
S = 50
burn = S * .1
show_progress <- T
fast = F
R <- NULL
all_patterns <- FALSE
m <- c(.05, .95, .05, .95, .05, .95, .05, .95, .05, .95)
u <- c(.99, .01, .99, .01,
1 - 1/30, 1/30, 1 - 1/12, 1/12, 1 - 1/15, 1/15)
levels <- c(2, 2, 2, 2, 2)
S <- 1000; burn <- S * .1
m_prior <- u_prior <- rep(1, length(m))
alpha <- beta <- 1
cd <- simulate_comparisons(m, u, levels, n1, n2, overlap)
hash <- hash_comparisons(cd)
threshold = 1e-5
tmax = 1000
fixed_iterations = NULL
b_init = TRUE
B = 20
holdout_size = 20
k = 1
tau = 1
seed = 0
set.seed(seed)
check_every <- 10
ohe <- hash$ohe # One-hot encodings e(h_p)
P <- dim(ohe)[1]
total_counts <- hash$total_counts #N_p
pattern_counts_by_record <- hash$pattern_counts_by_record #N_p_j
record_counts_by_pattern <- hash$record_counts_by_pattern
field_marker <- hash$field_marker
n1 <- hash$n1
n2 <- hash$n2
# Priors
alpha <- rep(1, length(field_marker))
Beta <- rep(1, length(field_marker))
alpha_pi <- 1
beta_pi <- 1
# Initialize
a <- rep(1, length(field_marker))
if(b_init == T){
b <- hash$ohe %>%
sweep(., 1, hash$total_counts, "*") %>%
colSums()
} else {
b = rep(1, length(field_marker))
}
a_pi <- 1
b_pi <- 1
t <- 1
ratio <- 1
elbo_seq <- vector()
adjustment <- n2 / B
holdout <- sample(1:n2, holdout_size)
while(t <= tmax){
a_sum <- a %>%
split(., field_marker) %>%
sapply(., sum) %>%
digamma(.) %>%
.[field_marker]
a_chunk <- digamma(a) - a_sum
b_sum <- b %>%
split(., field_marker) %>%
sapply(., sum) %>%
digamma(.) %>%
.[field_marker]
b_chunk <- digamma(b) - b_sum
m_p <- ohe %>%
sweep(., 2, a_chunk, "*") %>%
rowSums()
u_p <- ohe %>%
sweep(., 2, b_chunk, "*") %>%
rowSums()
# w_p
weights = m_p - u_p
# phi_single
phi <- exp(digamma(a_pi) - digamma(n1) + weights)
single <- exp(digamma(b_pi))
# Phi_j
batch <- sample(1:n2, B, replace = F)
C <- sapply(batch, function(x){
pattern_counts_by_record[[x]] %*% phi + single
})
# S(Phi)
total_nonmatch <- adjustment * sum(single/ C)
total_counts <- lapply(batch, function(x){
hash$pattern_counts_by_record[[x]]
}) %>%
do.call(rbind, .) %>%
colSums() * adjustment
# N_p(Psi)
K <- sapply(1:P, function(p){
sum(record_counts_by_pattern[[p]][batch]/C)
}) * adjustment
epsilon <- (t + tau) ^ (-k)
AZ <- ohe %>%
sweep(., 1, phi * K, "*") %>%
colSums()
BZ <- ohe %>%
sweep(., 1, total_counts - (phi * K), "*") %>%
colSums()
a <- (1 - epsilon) * a + epsilon * (alpha + AZ)
b <- (1 - epsilon) * b + epsilon * (Beta + BZ)
a_pi <- (1 - epsilon) * a_pi  +
epsilon * (alpha_pi + n2 - total_nonmatch)
b_pi <- (1 - epsilon) * b_pi +
epsilon * (beta_pi + total_nonmatch)
# ELBO
elbo_pieces <- vector(length = 6)
C_holdout <- sapply(holdout, function(x){
pattern_counts_by_record[[x]] %*% phi + single
})
holdout_nonmatch <- n2/holdout_size * sum(single/ C_holdout)
# elbo_pieces[1] <- sapply(seq_along(holdout), function(j){
#   record <- batch[j]
#   sum(pattern_counts_by_record[[record]] * (phi *(weights - log(phi) + log(C[j]))/ C[j] +
#                                          u_p))
# }) %>%
#   sum(.) * adjustment
#
# elbo_pieces[2] <-  single * adjustment * sum(1/C *log(C)) + total_nonmatch * log(n1) -log(n1)*n2
#
elbo_pieces[1] <- sapply(seq_along(holdout), function(j){
record <- holdout[j]
sum(pattern_counts_by_record[[record]] * (phi *(weights - log(phi) + log(C_holdout[j]))/ C_holdout[j] +
u_p))
}) %>%
sum(.) * n2/ holdout_size
elbo_pieces[2] <-  n2/ holdout_size * single * sum(1/C_holdout *log(C_holdout)) + holdout_nonmatch * (log(n1) - log(single)) -log(n1)*n2
elbo_pieces[3] <- lbeta(a_pi, b_pi) - lbeta(alpha_pi, beta_pi)
elbo_pieces[4] <- sapply(list(a, b), function(y){
split(y, field_marker) %>%
sapply(., function(x){
sum(lgamma(x)) - lgamma(sum(x))
})%>%
sum(.)
}) %>%
sum(.)
elbo_pieces[5] <- -sapply(list(alpha, Beta), function(y){
split(y, field_marker) %>%
sapply(., function(x){
sum(lgamma(x)) - lgamma(sum(x))
})%>%
sum(.)
}) %>%
sum(.)
elbo_pieces[6] <- sum((alpha - a) * a_chunk + (Beta - b) * b_chunk)
elbo <- sum(elbo_pieces)
elbo_seq <- c(elbo_seq, elbo)
if(is.null(fixed_iterations)){
if(t %% check_every == 0){
ratio <- abs((elbo_seq[t] - elbo_seq[t - check_every +1])/
elbo_seq[t - check_every +1])
}
if(ratio < threshold){
break
}
}
t <- t + 1
if(t > tmax){
print("Max iterations have passed before convergence")
break
}
if(!is.null(fixed_iterations)){
if(t == fixed_iterations){
break
}
}
}
C <- sapply(1:n2, function(x){
pattern_counts_by_record[[x]] %*% phi + single
})
list(pattern_weights = phi,
C = C,
a = a,
b = b,
a_pi = a_pi,
b_pi = b_pi,
elbo_seq = elbo_seq,
t = t)
devtools::load_all(".")
library(RecordLinkage)
library(glue)
library(tictoc)
data <- RecordLinkage::RLdata10000 %>%
mutate(unique_id = RecordLinkage::identity.RLdata10000)
duplicates <- nrow(data) * .1
duplicated_ids <- data %>%
filter(duplicated(unique_id)) %>%
select(unique_id) %>%
pull()
duplicated_records <- data %>%
filter(unique_id %in% duplicated_ids) %>%
arrange(unique_id) %>%
mutate(rn = row_number())
duplicated_1 <- duplicated_records %>%
filter(rn %% 2 == 0)
duplicated_2 <- duplicated_records %>%
filter(rn %% 2 == 1)
non_duplicated_records <- data %>%
filter(!(unique_id %in% duplicated_ids)) %>%
mutate(rn = row_number())
non_duplicated_1 <- non_duplicated_records %>%
filter(rn %% 2 == 0)
non_duplicated_2 <- non_duplicated_records %>%
filter(rn %% 2 == 1)
df1 <- rbind(duplicated_1, non_duplicated_1)
df2 <- rbind(duplicated_2, non_duplicated_2)
n1 <- nrow(df1)
n2 <- nrow(df2)
Z_true <- rep(0, nrow(df1))
Z_true[1:duplicates] <- 1:duplicates
fields <- c(1, 3, 5, 6, 7)
types <- c("lv", "lv", "bi", "bi", "bi")
cd <- compare_records(df1, df2, flds = fields, types = types,
breaks = c(0, .15))
hash <- hash_comparisons(cd, all_patterns = F)
kappa_vec <- c(.5, .6, .7, .8, .9, 1)
B <- 1000
holdout_size <- 1000
tau <-  1
seed = 0
b_init = T
set.seed(seed)
check_every <- 10
ohe <- hash$ohe # One-hot encodings e(h_p)
P <- dim(ohe)[1]
total_counts <- hash$total_counts #N_p
pattern_counts_by_record <- hash$pattern_counts_by_record #N_p_j
record_counts_by_pattern <- hash$record_counts_by_pattern
field_marker <- hash$field_marker
n1 <- hash$n1
n2 <- hash$n2
# Priors
alpha <- rep(1, length(field_marker))
Beta <- rep(1, length(field_marker))
alpha_pi <- 1
beta_pi <- 1
# Initialize
a <- rep(1, length(field_marker))
if(b_init == T){
b <- hash$ohe %>%
sweep(., 1, hash$total_counts, "*") %>%
colSums()
} else {
b = rep(1, length(field_marker))
}
a_pi <- 1
b_pi <- 1
t <- 1
ratio <- 1
elbo_seq <- vector()
adjustment <- n2 / B
holdout <- sample(1:n2, holdout_size)
while(t <= tmax){
a_sum <- a %>%
split(., field_marker) %>%
sapply(., sum) %>%
digamma(.) %>%
.[field_marker]
a_chunk <- digamma(a) - a_sum
b_sum <- b %>%
split(., field_marker) %>%
sapply(., sum) %>%
digamma(.) %>%
.[field_marker]
b_chunk <- digamma(b) - b_sum
m_p <- ohe %>%
sweep(., 2, a_chunk, "*") %>%
rowSums()
u_p <- ohe %>%
sweep(., 2, b_chunk, "*") %>%
rowSums()
# w_p
weights = m_p - u_p
# phi_single
phi <- exp(digamma(a_pi) - digamma(n1) + weights)
single <- exp(digamma(b_pi))
# Phi_j
batch <- sample(1:n2, B, replace = F)
C <- sapply(batch, function(x){
pattern_counts_by_record[[x]] %*% phi + single
})
# S(Phi)
total_nonmatch <- adjustment * sum(single/ C)
total_counts <- lapply(batch, function(x){
hash$pattern_counts_by_record[[x]]
}) %>%
do.call(rbind, .) %>%
colSums() * adjustment
# N_p(Psi)
K <- sapply(1:P, function(p){
sum(record_counts_by_pattern[[p]][batch]/C)
}) * adjustment
epsilon <- (t + tau) ^ (-k)
AZ <- ohe %>%
sweep(., 1, phi * K, "*") %>%
colSums()
BZ <- ohe %>%
sweep(., 1, total_counts - (phi * K), "*") %>%
colSums()
a <- (1 - epsilon) * a + epsilon * (alpha + AZ)
b <- (1 - epsilon) * b + epsilon * (Beta + BZ)
a_pi <- (1 - epsilon) * a_pi  +
epsilon * (alpha_pi + n2 - total_nonmatch)
b_pi <- (1 - epsilon) * b_pi +
epsilon * (beta_pi + total_nonmatch)
# ELBO
elbo_pieces <- vector(length = 6)
C_holdout <- sapply(holdout, function(x){
pattern_counts_by_record[[x]] %*% phi + single
})
holdout_nonmatch <- n2/holdout_size * sum(single/ C_holdout)
# elbo_pieces[1] <- sapply(seq_along(holdout), function(j){
#   record <- batch[j]
#   sum(pattern_counts_by_record[[record]] * (phi *(weights - log(phi) + log(C[j]))/ C[j] +
#                                          u_p))
# }) %>%
#   sum(.) * adjustment
#
# elbo_pieces[2] <-  single * adjustment * sum(1/C *log(C)) + total_nonmatch * log(n1) -log(n1)*n2
#
elbo_pieces[1] <- sapply(seq_along(holdout), function(j){
record <- holdout[j]
sum(pattern_counts_by_record[[record]] * (phi *(weights - log(phi) + log(C_holdout[j]))/ C_holdout[j] +
u_p))
}) %>%
sum(.) * n2/ holdout_size
elbo_pieces[2] <-  n2/ holdout_size * single * sum(1/C_holdout *log(C_holdout)) + holdout_nonmatch * (log(n1) - log(single)) -log(n1)*n2
elbo_pieces[3] <- lbeta(a_pi, b_pi) - lbeta(alpha_pi, beta_pi)
elbo_pieces[4] <- sapply(list(a, b), function(y){
split(y, field_marker) %>%
sapply(., function(x){
sum(lgamma(x)) - lgamma(sum(x))
})%>%
sum(.)
}) %>%
sum(.)
elbo_pieces[5] <- -sapply(list(alpha, Beta), function(y){
split(y, field_marker) %>%
sapply(., function(x){
sum(lgamma(x)) - lgamma(sum(x))
})%>%
sum(.)
}) %>%
sum(.)
elbo_pieces[6] <- sum((alpha - a) * a_chunk + (Beta - b) * b_chunk)
elbo <- sum(elbo_pieces)
elbo_seq <- c(elbo_seq, elbo)
if(is.null(fixed_iterations)){
if(t %% check_every == 0){
ratio <- abs((elbo_seq[t] - elbo_seq[t - check_every +1])/
elbo_seq[t - check_every +1])
}
if(ratio < threshold){
break
}
}
t <- t + 1
if(t > tmax){
print("Max iterations have passed before convergence")
break
}
if(!is.null(fixed_iterations)){
if(t == fixed_iterations){
break
}
}
}
C <- sapply(1:n2, function(x){
pattern_counts_by_record[[x]] %*% phi + single
})
list(pattern_weights = phi,
C = C,
a = a,
b = b,
a_pi = a_pi,
b_pi = b_pi,
elbo_seq = elbo_seq,
t = t)
tmax
threshold
ratio
threshold
k
svi_efficient(hash, k = 1, B = 1000)
