mutate(rn = row_number())
non_duplicated_1 <- non_duplicated_records %>%
filter(rn %% 2 == 0)
non_duplicated_2 <- non_duplicated_records %>%
filter(rn %% 2 == 1)
df1 <- rbind(duplicated_1, non_duplicated_1)
df2 <- rbind(duplicated_2, non_duplicated_2)
n1 <- nrow(df1)
n2 <- nrow(df2)
Z_true <- rep(0, nrow(df1))
Z_true[1:duplicates] <- 1:duplicates
fields <- c(1, 3, 5, 6, 7)
types <- c("lv", "lv", "bi", "bi", "bi")
cd <- compare_records(df1, df2, flds = fields, types = types,
breaks = c(0, .15))
hash <- hash_comparisons(cd, all_patterns = F)
n1 <- hash$n1
n2 <- hash$n2
field_marker <- hash$field_marker
unique_patterns <- hash$ohe
pattern_counts <- hash$total_counts
P <- nrow(unique_patterns)
counts_by_rec <- hash$pattern_counts_by_record
hash_to_file_1 <-hash$hash_to_file_1
pair_to_pattern <- hash$pair_to_pattern
#candidates_P <- 1:(P+1)
candidates_P <- 0:P
Z.SAMPS <- matrix(NA, nrow = n2, ncol = S)
M.SAMPS <- matrix(NA, nrow = length(field_marker), ncol = S)
Z <- rep(0, n2)
Z_pattern <- rep(0, n2)
Z_inv <- rep(0, n1)
L <- 0
m <- u <- rep(0, length(field_marker))
matches <- rep(0, P)
AZ <- sweep(unique_patterns, MARGIN = 1, STAT = matches, FUN = "*") %>%
colSums() %>%
unname()
BZ <- sweep(unique_patterns, MARGIN = 1, STAT = nonmatches, FUN = "*") %>%
colSums() %>%
unname()
nonmatches <- pattern_counts - matches
BZ <- sweep(unique_patterns, MARGIN = 1, STAT = nonmatches, FUN = "*") %>%
colSums() %>%
unname()
m_post <- m_prior + AZ
u_post <- u_prior + BZ
m_post <- split(m_post, field_marker)
m <- as.vector(unlist(sapply(m_post, function(x){
prob <- MCMCpack::rdirichlet(1, x)
prob/sum(prob)
})))
u <- as.vector(unlist(sapply(u_post, function(x){
prob <- MCMCpack::rdirichlet(1, x)
prob/sum(prob)
})))
ratio <- (log(m) - log(u)) %>%
rep(., P) %>%
matrix(., nrow = P, byrow = TRUE)
m_prior = 1
u_prior = 1
m_post <- split(m_post, field_marker)
m_post <- m_prior + AZ
u_post <- u_prior + BZ
m_post <- split(m_post, field_marker)
m <- as.vector(unlist(sapply(m_post, function(x){
prob <- MCMCpack::rdirichlet(1, x)
prob/sum(prob)
})))
u_post <- split(u_post, field_marker)
u <- as.vector(unlist(sapply(u_post, function(x){
prob <- MCMCpack::rdirichlet(1, x)
prob/sum(prob)
})))
ratio <- (log(m) - log(u)) %>%
rep(., P) %>%
matrix(., nrow = P, byrow = TRUE)
unique_weights <- exp(rowSums(ratio * unique_patterns, na.rm = TRUE))
for(j in 1:n2){
if(Z[j] > 0){
L <- L - 1
Z_inv[Z[j]] <- 0
}
Z[j] <- 0
empty_weight <- (n1 - L) * (n2 - L - 1 + beta) / (L + alpha)
if(mode == "base"){
available <- which(Z_inv == 0)
temp_weights <- c(empty_weight, unique_weights[pair_to_pattern[[j]][available]])
Z[j] <- sample(c(0, available), 1, prob = temp_weights)
if(Z[j] > 0){
Z_pattern[j] <- pair_to_pattern[[j]][Z[j]]
}
else{
Z_pattern[j] <- 0
}
}
else if(mode == "efficient"){
n_current <- counts_by_rec[[j]]
for(k in 1:n2){
if(Z[k] > 0){
ind <- pair_to_pattern[[j]][Z[k]]
n_current[ind] <- n_current[ind] - 1
}
}
temp_weights <- n_current * unique_weights
probs <- c(empty_weight, temp_weights)
pattern <- sample(candidates_P, 1, prob = probs)
if(pattern == 0){
Z[j] <- 0
Z_pattern[j] <- 0
}
else{
flag_2 <- 1
npj <- counts_by_rec[[j]][pattern]
while(flag_2 == 1){
index <- ceiling(runif(1) * npj)
i <- hash_to_file_1[[j]][[pattern]][index]
if(Z_inv[i] == 0){
Z[j] <- i
Z_pattern[j] <- pattern
flag_2 <- 0
}
}
}
}
else if(mode == "rejection"){
hash_weights <- counts_by_rec[[j]] * unique_weights
probs <- c(empty_weight, hash_weights)
flag <- 1
iter <- 0
while(flag == 1){
pattern <- sample(candidates_P, 1, prob = probs)
if(pattern == 0){
Z[j] <- 0
Z_pattern[j] <- 0
flag <- 0
}
else{
index <- ceiling(runif(1) * counts_by_rec[[j]][pattern])
i <- hash_to_file_1[[j]][[pattern]][index]
if(Z_inv[i] == 0){
Z[j] <- i
Z_pattern[j] <- pattern
flag <- 0
}
}
iter <- iter + 1
if(iter == reject_iter){
# O(n1)
available <- which(Z_inv == 0)
temp_weights <- c(empty_weight, unique_weights[pair_to_pattern[[j]][available]])
Z[j] <- sample(c(0, available), 1, prob = temp_weights)
if(Z[j] > 0){
Z_pattern[j] <- pair_to_pattern[[j]][Z[j]]
}
else{
Z_pattern[j] <- 0
}
# O(n2 + P)
# n_current <- counts_by_rec[[j]]
# for(k in 1:n2){
#   if(Z[k] > 0){
#     ind <- pair_to_pattern[[j]][Z[k]]
#     n_current[ind] <- n_current[ind] - 1
#   }
# }
# temp_weights <- n_current * unique_weights
# probs <- c(empty_weight, temp_weights)
# pattern <- sample(candidates_P, 1, prob = probs)
# if(pattern == 0){
#   Z[j] <- 0
#   Z_pattern[j] <- 0
# }
# else{
#   flag_2 <- 1
#   npj <- counts_by_rec[[j]][pattern]
#   while(flag_2 == 1){
#     index <- ceiling(runif(1) * npj)
#     i <- hash_to_file_1[[j]][[pattern]][index]
#     if(Z_inv[i] == 0){
#       Z[j] <- i
#       Z_pattern[j] <- pattern
#       flag_2 <- 0
#     }
#   }
# }
flag <- 0
}
}
}
if(Z[j] > 0){
L <- L + 1
Z_inv[Z[j]] <- 1
}
}
beta = 1
alpha =1
for(j in 1:n2){
if(Z[j] > 0){
L <- L - 1
Z_inv[Z[j]] <- 0
}
Z[j] <- 0
empty_weight <- (n1 - L) * (n2 - L - 1 + beta) / (L + alpha)
if(mode == "base"){
available <- which(Z_inv == 0)
temp_weights <- c(empty_weight, unique_weights[pair_to_pattern[[j]][available]])
Z[j] <- sample(c(0, available), 1, prob = temp_weights)
if(Z[j] > 0){
Z_pattern[j] <- pair_to_pattern[[j]][Z[j]]
}
else{
Z_pattern[j] <- 0
}
}
else if(mode == "efficient"){
n_current <- counts_by_rec[[j]]
for(k in 1:n2){
if(Z[k] > 0){
ind <- pair_to_pattern[[j]][Z[k]]
n_current[ind] <- n_current[ind] - 1
}
}
temp_weights <- n_current * unique_weights
probs <- c(empty_weight, temp_weights)
pattern <- sample(candidates_P, 1, prob = probs)
if(pattern == 0){
Z[j] <- 0
Z_pattern[j] <- 0
}
else{
flag_2 <- 1
npj <- counts_by_rec[[j]][pattern]
while(flag_2 == 1){
index <- ceiling(runif(1) * npj)
i <- hash_to_file_1[[j]][[pattern]][index]
if(Z_inv[i] == 0){
Z[j] <- i
Z_pattern[j] <- pattern
flag_2 <- 0
}
}
}
}
else if(mode == "rejection"){
hash_weights <- counts_by_rec[[j]] * unique_weights
probs <- c(empty_weight, hash_weights)
flag <- 1
iter <- 0
while(flag == 1){
pattern <- sample(candidates_P, 1, prob = probs)
if(pattern == 0){
Z[j] <- 0
Z_pattern[j] <- 0
flag <- 0
}
else{
index <- ceiling(runif(1) * counts_by_rec[[j]][pattern])
i <- hash_to_file_1[[j]][[pattern]][index]
if(Z_inv[i] == 0){
Z[j] <- i
Z_pattern[j] <- pattern
flag <- 0
}
}
iter <- iter + 1
if(iter == reject_iter){
# O(n1)
available <- which(Z_inv == 0)
temp_weights <- c(empty_weight, unique_weights[pair_to_pattern[[j]][available]])
Z[j] <- sample(c(0, available), 1, prob = temp_weights)
if(Z[j] > 0){
Z_pattern[j] <- pair_to_pattern[[j]][Z[j]]
}
else{
Z_pattern[j] <- 0
}
# O(n2 + P)
# n_current <- counts_by_rec[[j]]
# for(k in 1:n2){
#   if(Z[k] > 0){
#     ind <- pair_to_pattern[[j]][Z[k]]
#     n_current[ind] <- n_current[ind] - 1
#   }
# }
# temp_weights <- n_current * unique_weights
# probs <- c(empty_weight, temp_weights)
# pattern <- sample(candidates_P, 1, prob = probs)
# if(pattern == 0){
#   Z[j] <- 0
#   Z_pattern[j] <- 0
# }
# else{
#   flag_2 <- 1
#   npj <- counts_by_rec[[j]][pattern]
#   while(flag_2 == 1){
#     index <- ceiling(runif(1) * npj)
#     i <- hash_to_file_1[[j]][[pattern]][index]
#     if(Z_inv[i] == 0){
#       Z[j] <- i
#       Z_pattern[j] <- pattern
#       flag_2 <- 0
#     }
#   }
# }
flag <- 0
}
}
}
if(Z[j] > 0){
L <- L + 1
Z_inv[Z[j]] <- 1
}
}
j = 1
if(Z[j] > 0){
L <- L - 1
Z_inv[Z[j]] <- 0
}
Z[j] <- 0
empty_weight <- (n1 - L) * (n2 - L - 1 + beta) / (L + alpha)
n_current <- counts_by_rec[[j]]
for(k in 1:n2){
if(Z[k] > 0){
ind <- pair_to_pattern[[j]][Z[k]]
n_current[ind] <- n_current[ind] - 1
}
}
temp_weights <- n_current * unique_weights
probs <- c(empty_weight, temp_weights)
pattern <- sample(candidates_P, 1, prob = probs)
if(pattern == 0){
Z[j] <- 0
Z_pattern[j] <- 0
}
else{
mode = "efficient"
mode
mode
for(j in 1:n2){
if(Z[j] > 0){
L <- L - 1
Z_inv[Z[j]] <- 0
}
Z[j] <- 0
empty_weight <- (n1 - L) * (n2 - L - 1 + beta) / (L + alpha)
if(mode == "base"){
available <- which(Z_inv == 0)
temp_weights <- c(empty_weight, unique_weights[pair_to_pattern[[j]][available]])
Z[j] <- sample(c(0, available), 1, prob = temp_weights)
if(Z[j] > 0){
Z_pattern[j] <- pair_to_pattern[[j]][Z[j]]
}
else{
Z_pattern[j] <- 0
}
}
else if(mode == "efficient"){
n_current <- counts_by_rec[[j]]
for(k in 1:n2){
if(Z[k] > 0){
ind <- pair_to_pattern[[j]][Z[k]]
n_current[ind] <- n_current[ind] - 1
}
}
temp_weights <- n_current * unique_weights
probs <- c(empty_weight, temp_weights)
pattern <- sample(candidates_P, 1, prob = probs)
if(pattern == 0){
Z[j] <- 0
Z_pattern[j] <- 0
}
else{
flag_2 <- 1
npj <- counts_by_rec[[j]][pattern]
while(flag_2 == 1){
index <- ceiling(runif(1) * npj)
i <- hash_to_file_1[[j]][[pattern]][index]
if(Z_inv[i] == 0){
Z[j] <- i
Z_pattern[j] <- pattern
flag_2 <- 0
}
}
}
}
else if(mode == "rejection"){
hash_weights <- counts_by_rec[[j]] * unique_weights
probs <- c(empty_weight, hash_weights)
flag <- 1
iter <- 0
while(flag == 1){
pattern <- sample(candidates_P, 1, prob = probs)
if(pattern == 0){
Z[j] <- 0
Z_pattern[j] <- 0
flag <- 0
}
else{
index <- ceiling(runif(1) * counts_by_rec[[j]][pattern])
i <- hash_to_file_1[[j]][[pattern]][index]
if(Z_inv[i] == 0){
Z[j] <- i
Z_pattern[j] <- pattern
flag <- 0
}
}
iter <- iter + 1
if(iter == reject_iter){
# O(n1)
available <- which(Z_inv == 0)
temp_weights <- c(empty_weight, unique_weights[pair_to_pattern[[j]][available]])
Z[j] <- sample(c(0, available), 1, prob = temp_weights)
if(Z[j] > 0){
Z_pattern[j] <- pair_to_pattern[[j]][Z[j]]
}
else{
Z_pattern[j] <- 0
}
# O(n2 + P)
# n_current <- counts_by_rec[[j]]
# for(k in 1:n2){
#   if(Z[k] > 0){
#     ind <- pair_to_pattern[[j]][Z[k]]
#     n_current[ind] <- n_current[ind] - 1
#   }
# }
# temp_weights <- n_current * unique_weights
# probs <- c(empty_weight, temp_weights)
# pattern <- sample(candidates_P, 1, prob = probs)
# if(pattern == 0){
#   Z[j] <- 0
#   Z_pattern[j] <- 0
# }
# else{
#   flag_2 <- 1
#   npj <- counts_by_rec[[j]][pattern]
#   while(flag_2 == 1){
#     index <- ceiling(runif(1) * npj)
#     i <- hash_to_file_1[[j]][[pattern]][index]
#     if(Z_inv[i] == 0){
#       Z[j] <- i
#       Z_pattern[j] <- pattern
#       flag_2 <- 0
#     }
#   }
# }
flag <- 0
}
}
}
if(Z[j] > 0){
L <- L + 1
Z_inv[Z[j]] <- 1
}
}
Z
hash_matches <- factor(Z_pattern, levels = 0:P)
df <- data.frame(hash_matches)
matches <- df %>%
group_by(hash_matches, .drop = F) %>%
count() %>%
filter(hash_matches != 0) %>%
pull()
devtools::load_all(".")
chain <- brl_efficient_serge(hash, S = 50)
devtools::install_github("briankundinger/fabldev")
library(RecordLinkage)
library(glue)
library(tictoc)
library(fabldev)
data <- RecordLinkage::RLdata10000 %>%
mutate(unique_id = RecordLinkage::identity.RLdata10000)
duplicates <- nrow(data) * .1
duplicated_ids <- data %>%
filter(duplicated(unique_id)) %>%
select(unique_id) %>%
pull()
duplicated_records <- data %>%
filter(unique_id %in% duplicated_ids) %>%
arrange(unique_id) %>%
mutate(rn = row_number())
duplicated_1 <- duplicated_records %>%
filter(rn %% 2 == 0)
duplicated_2 <- duplicated_records %>%
filter(rn %% 2 == 1)
non_duplicated_records <- data %>%
filter(!(unique_id %in% duplicated_ids)) %>%
mutate(rn = row_number())
non_duplicated_1 <- non_duplicated_records %>%
filter(rn %% 2 == 0)
non_duplicated_2 <- non_duplicated_records %>%
filter(rn %% 2 == 1)
df1 <- rbind(duplicated_1, non_duplicated_1)
df2 <- rbind(duplicated_2, non_duplicated_2)
n1 <- nrow(df1)
n2 <- nrow(df2)
Z_true <- rep(0, nrow(df1))
Z_true[1:duplicates] <- 1:duplicates
fields <- c(1, 3, 5, 6, 7)
types <- c("lv", "lv", "bi", "bi", "bi")
cd <- compare_records(df1, df2, flds = fields, types = types,
breaks = c(0, .15))
hash <- hash_comparisons(cd, all_patterns = F)
chain <- brl_efficient_serge(hash, S = 50)
chain$Z
chain <- brl_efficient_serge(hash, S = 50, mode = "rejection")
roxygen2::roxygenize()
roxygen2::roxygenize()
getwd()
hash <- readRDS("../vablpaper/out/ncvr/combine/hash")
hash <- readRDS("deprecated/hash_fabl")
